LIBSRC := $(wildcard lib/*.c)
LIBOBJ := $(patsubst %.c,%.o,$(LIBSRC))
LIBARC := lib/pwm.a

BUILTINSRC := $(wildcard builtin/*.c)
BUILTINOBJ := $(patsubst %.c,%.o,$(BUILTINSRC))
BUILTINBIN := $(patsubst %.o,%,$(BUILTINOBJ))

SRC := pwm.c
BIN := $(patsubst %.c,%,$(SRC))

BINDIR     := @prefix@/bin
PWMEXECDIR := @pwmexecdir@

CPPFLAGS += -D_BSD_SOURCE
CFLAGS += -std=c99 -Wall -O2 -Ilib
LDFLAGS += -lgpgme -lgit2

.PHONY: all
all: $(BIN) $(BUILTINBIN)

$(BIN): $(SRC)
	$(CC) $(CFLAGS) $(CPPFLAGS) -o $@ $^

$(BUILTINBIN): %: %.o $(LIBARC)
	$(CC) $(LDFLAGS) -o $@ $^

$(BUILTINOBJ): %.o: %.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c -o $@ $^

$(LIBARC): $(LIBOBJ)
	$(AR) csr $@ $^

$(LIBOBJ): %.o: %.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c -o $@ $^

.PHONY: doc
doc:
	cm doc docurium.json

.PHONY: install
install:
	install -Dm 0755 $(BIN) $(DESTDIR)$(BINDIR)/$(BIN)
	install -dm 0755 $(DESTDIR)$(PWMEXECDIR)
	install -m 0755 $(BUILTINBIN) $(DESTDIR)$(PWMEXECDIR)

.PHONY: clean
clean:
	rm -f $(LIBOBJ) $(LIBARC) $(BUILTINOBJ) $(BUILTINBIN) $(BIN)
